import streamlit as st
import pandas as pd
from st_aggrid import AgGrid, GridOptionsBuilder, GridUpdateMode
import plotly.express as px

from threshold_engine import prepare_currency_df, build_threshold_maps, map_groups_to_instruments
from trade_analyzer import apply_thresholds, summarize_by_group, summarize_by_entity
from visualizer import plot_alert_comparison, plot_legal_entity_breakdown

st.set_page_config(layout="wide", page_title="GFX Threshold Backtester App")
st.title("üìâ GFX Threshold Backtesting App")

st.header("Step 1: Upload Files")
col1, col2 = st.columns(2)

with col1:
    group_file = st.file_uploader("Upload Threshold Mapping File", type=["csv", "xlsx"])
with col2:
    trade_file = st.file_uploader("Upload Trade File", type=["csv", "xlsx"])

edit_mode = st.radio("Edit Mode", ["Group-Wise", "Currency-Wise"], horizontal=True)

if group_file and trade_file:
    full_df = pd.read_excel(group_file) if group_file.name.endswith("xlsx") else pd.read_csv(group_file)
    trade_df = pd.read_excel(trade_file) if trade_file.name.endswith("xlsx") else pd.read_csv(trade_file)

    col3, col4 = st.columns([2.5, 1.5])
    with col3:
        st.subheader("‚úèÔ∏è Edit Thresholds")
        editable_df = full_df[["CCY", "Proposed_Group", "Old_Threshold", "Proposed_Threshold"]].copy()
        editable_df.rename(columns={"Proposed_Group": "Group"}, inplace=True)
        editable_df["Final_Threshold"] = editable_df["Proposed_Threshold"]
        if st.button("Reset Final Thresholds"):
            editable_df["Final_Threshold"] = editable_df["Proposed_Threshold"]
        gb = GridOptionsBuilder.from_dataframe(editable_df)
        gb.configure_columns(["Final_Threshold", "Group"], editable=True)
        grid_output = AgGrid(editable_df, gridOptions=gb.build(), update_mode=GridUpdateMode.VALUE_CHANGED, height=400)
        currency_df = grid_output["data"]
        currency_df, group_bounds = prepare_currency_df(currency_df)

    with col4:
        st.subheader("Summary Stats")
        st.metric("Total Trades", len(trade_df))
        st.metric("Currency Pairs", trade_df["Instrument"].nunique())
        st.metric("Legal Entities", trade_df["LegalEntity"].nunique())

    # Threshold computation
    threshold_maps = build_threshold_maps(currency_df)
    trade_df = apply_thresholds(trade_df, threshold_maps)
    trade_df = map_groups_to_instruments(trade_df, currency_df)

    # Summary metrics
    st.metric("Alerts wrt Existing Threshold", int(trade_df["Alert_Old"].sum()))
    st.metric("Alerts After Calibration", int(trade_df["Alert_Final"].sum()))
    st.metric("No Alerts", int((~trade_df["Alert_Final"]).sum()))

    st.header("Step 2: Visual Summary")

    st.subheader("üìä Group-wise Impact Summary")
    group_summary = summarize_by_group(currency_df, trade_df)
    st.dataframe(group_summary)

    st.plotly_chart(plot_alert_comparison(trade_df), use_container_width=True)

    st.subheader("üìç Legal Entity Breakdown")
    entity_df = summarize_by_entity(trade_df)
    st.plotly_chart(plot_legal_entity_breakdown(entity_df), use_container_width=True)

    with st.expander("Toggle Views: Chart or Table"):
        view_mode = st.radio("Select View", ["Aggregate Chart", "Legal Entity Table"], horizontal=True)
        if view_mode == "Legal Entity Table":
            entity_pivot = entity_df.pivot(index="LegalEntity", columns="Scenario", values="Alert Count").fillna(0).reset_index()
            st.dataframe(entity_pivot)

    st.download_button("Download Full Trade Analysis", trade_df.to_csv(index=False), "fx_alert_comparison_final.csv", "text/csv")

    st.subheader("Audit Trail")
    audit_df = currency_df.copy()
    audit_df["Changed?"] = audit_df["Final_Threshold"] != audit_df["Proposed_Threshold"]
    audit_df["Change %"] = ((audit_df["Final_Threshold"] - audit_df["Proposed_Threshold"]) / audit_df["Proposed_Threshold"]).round(3)
    st.dataframe(audit_df)
    st.download_button("Download Audit Trail", audit_df.to_csv(index=False), "threshold_audit_trail.csv", "text/csv")
